<?xml version="1.0" encoding="UTF-8"?>
<server:Capo xmlns:server="http://www.delcyon.com/capo-server"
             xmlns:client="http://www.delcyon.com/capo-client"
             xmlns:resource="http://www.delcyon.com/capo/resource"
             xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
             mainGroup="default"
             name="main">
    
    <server:group name="default">
       
       <!-- <resource:file localName="localName" uri="uri">-->
            <!-- context = content -->
            <!-- metatdata = ../@* -->
            <!-- constraint = name of something in current context -->
            <!-- constaraintType = the kind of evaluation to do -->
            <!-- value aka. test = test to run against constraint if exists -->
            <!-- we need a rule vs. a test? This should act as the join clause vs. the where clause -->
            <!-- restriction vs. join -->            
            <!-- path = resource type local path, not understandable by other resource types -->
            <!-- xpath = resource document path, with context equal to current content -->
        <!--</resource:file>-->
       
        
        <!-- Start with the resource that we want to search against -->
        <!--<server:search name="fileTestSearch"  uri="clients" dumpVars="true" sleep="1000" dumpRef="..">
            <resource:child name="client" path="*">
                <resource:include xpath="../@localname"/>
                <resource:child path="status.xml">
                    <resource:rule  constraintType="eval"  value="status/@lastConnectTime > now() - 1hr"/>
                    <resource:child path="../identity.xml">
                        <resource:include xpath="server:identity/server:id[@name = 'MAC']"/>
                        <resource:include xpath="server:identity/server:id[@name = 'IP']"/>
                    </resource:child>
                </resource:child>                
            </resource:child>
        </server:search>-->
    
        <!-- Start with the resource that we want to search against -->
        <server:var name="clientName" value="%"/>
        
        <resource:resource name="jdbcTestResource"  uri="jdbc:hsqldb:file:testdb/testdb?user=user" >
            <resource:parameter name="password" value=""/>

            <resource:child name="systems" path="SYSTEMS" joinType="inner">

                <resource:rule match="any">
                    <resource:rule value="NAME like '${clientName}'"/>
                    <resource:rule value="LAST_CONNECT &lt; now()"/>
                </resource:rule>               

                <resource:include name="NAME"/>
                <resource:include name="OS"/>
                <resource:include name="ID"/>
                
                <resource:child name="interfaces" path="INTERFACES" joinType="inner">                    
                    <resource:join parent="@ID" this="@SYSTEM_ID"/>
                    <resource:rule match="all">                        
                        <resource:rule value="STATUS = 'ACTIVE'"/>
                    </resource:rule>
                
                    <resource:include name="IP"/>
                    <resource:include name="MAC"/>
                    <resource:include name="SYSTEM_ID"/>
                </resource:child>
                
                <resource:child name="asc" path="system_service_asc" joinType="inner">                    
                    <resource:join parent="INTERFACES/@SYSTEM_ID" this="@SYSTEM_ID" />
                    
                    <resource:child name="services" path="services" joinType="inner">                    
                        <resource:join parent="@SERVICE_ID" this="@ID" />
                    </resource:child>
                    
                </resource:child>
                
            </resource:child>
            
        </resource:resource>
        
        <server:import name="jdbcTestImport" src="resource:jdbcTestResource/resource:systems"  dumpVars="true" sleep="1000" dumpRef=".."/>
    </server:group>
    
    
    
    <!--<server:sync name="RMplistSync" src="file:/Library/Preferences/com.apple.RemoteManagement.plist" dest="remote:file:/Library/Preferences/com.apple.RemoteManagement.plist"/>
    <server:if test="${RMplistSync}/@onCopy = 'true">
        <client:command exec="service RemoteManagement restart"/>
    </server:if>
    
    
    
    
    <server:resource name="badDNS" uri="remote:file:/etc/resolve.conf">        
        <resource:rule match="any">
            <resource:rule value="match(8.8.8.8)"/>
            <resource:rule value="match(4.2.2.2)"/>
        </resource:rule>
    </server:resource>
    
    
    <server:import name="temp" src="resource:badDNS"/>
    
    <server:append src="import.temp" value="${clientID}"/>    
     
    
    <server:append src="import.temp" dest="baddns.xml"/>-->
        
    
    
    <!-- new smaple output 
    <?xml version="1.0" encoding="UTF-8"?>
<server:group xmlns:client="http://www.delcyon.com/capo-client"
              xmlns:resource="http://www.delcyon.com/capo/resource"
              xmlns:server="http://www.delcyon.com/capo-server"
              xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
              name="default">
    <server:search dumpRef=".." dumpVars="true" name="testSearch" sleep="1000" uri="clients">
      <identity uri="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1">
         <server:id name="MAC" value="00:e0:81:b0:14:7f"/>
         <server:id name="hostname" value="bluejay.goodinassociates.com"/>
      </identity>
   </server:search>
</server:group>
    -->
    
    <!-- sample output 
    <file:clients xmlns:file="http://www.delcyon.com/capo/resource/file" 
        MD5="0" 
        container="true"
        executable="true"
        exists="true"
        lastModified="1342217486000"
        path="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients"
        readable="true"
        uri="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients"
        writeable="true">
        <file:capo.client.1 
            MD5="1ab50ed2306f45d81799968d15dc53051" 
            container="true" 
            executable="true"
            exists="true"
            lastModified="1343399703000"
            path="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1"
            readable="true"
            uri="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1"
            writeable="true">
            <file:status.xml 
                MD5="b7c9a648e0070fa021a7cf18d843d6df" 
                container="false"
                contentFormatType="XML"
                executable="false"
                exists="true"
                lastModified="1343399702000"
                mimeType="text/xml"
                path="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1/status.xml"
                readable="true"
                size="80"
                uri="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1/status.xml"
                writeable="true">
                <status lastConnectTime="1335193042006"/>
            </file:status.xml>
            <file:identity.xml 
                MD5="f38746da26ed4de157f199b885815972" 
                container="false"
                contentFormatType="XML"
                executable="false"
                exists="true"
                lastModified="1343399702000"
                mimeType="text/xml"
                path="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1/identity.xml"
                readable="true"
                size="247"
                uri="file:/home/jeremiah/java-work/delcyon-capo/capo/server/clients/capo.client.1/identity.xml"
                writeable="true">
                <server:identity>
                    <server:id name="MAC" value="00:e0:81:b0:14:7f"/>
                    <server:id name="hostname" value="bluejay.goodinassociates.com"/>
                </server:identity>
            </file:identity.xml>
        </file:capo.client.1>
    </file:clients>
    -->
</server:Capo>